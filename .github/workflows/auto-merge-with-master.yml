name: Auto PR from jconf

on:
  push:
    branches:
      - jconf

jobs:
  auto-pr:
    runs-on: ubuntu-latest

    container:
      image: archlinux:latest

    steps:
      - name: Install dependencies
        run: |
          pacman -Sy --noconfirm git base-devel
          pacman -S --noconfirm neovim gh

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Authenticate with GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GH_TOKEN" | gh auth login --with-token

      - name: Check if PR exists
        id: pr_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if gh pr list --head jconf --base main --state open | grep -q jconf; then
            echo "PR_EXISTS=true" >> "$GITHUB_ENV"
          else
            echo "PR_EXISTS=false" >> "$GITHUB_ENV"
          fi

      - name: Create PR
        if: env.PR_EXISTS == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "Auto update jconf" \
            --body "Automated PR from workflow" \
            --head jconf \
            --base main

      - name: Get PR number
        if: env.PR_EXISTS == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head jconf --base main --state open --json number --jq '.[0].number')
          echo "PR_NUMBER=$PR_NUMBER" >> "$GITHUB_ENV"

      - name: Enable auto-merge
        if: env.PR_EXISTS == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge "$PR_NUMBER" --auto --merge
